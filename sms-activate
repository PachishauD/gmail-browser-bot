import time
import time
import pyperclip
import pickle
import requests
import base64

from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.common.action_chains import ActionChains
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
# driver = webdriver.Chrome()



def copy(string):
    pyperclip.copy(string)

def driver_chrome_incognito():
    from undetected_chromedriver import Chrome, ChromeOptions
    chrome_options = ChromeOptions()
    chrome_options.add_argument("--incognito")
    chrome_options.add_argument('--log-level=3')
    chrome_options.add_argument('--encoding=UTF-8')
    chrome_options.add_argument("--log-level=OFF")
    chrome_options.set_capability("goog:loggingPrefs", {'performance': 'ALL'})
    driver = Chrome(options=chrome_options, version_main = 114)
    return driver


def login_to_gmail(driver, email, password, recovery_email):
    driver.get("https://gmail.com")
    try:
        WebDriverWait(driver, 5).until(EC.presence_of_element_located((By.NAME, "identifier")))
        input_email = driver.find_element(by=By.XPATH, value="//input[@name='identifier']")
        email_next = driver.find_element(by=By.ID, value="identifierNext")
        input_email.send_keys(email)
        email_next.click()
        time.sleep(2)
        try:
            WebDriverWait(driver, 5).until(EC.presence_of_element_located((By.NAME, "Passwd")))
            input_password = driver.find_element(by=By.NAME, value="Passwd")
            password_Next = driver.find_element(by=By.ID, value="passwordNext")
            ActionChains(driver=driver).move_to_element(input_password).click().send_keys(password).perform()
            ActionChains(driver=driver).move_to_element(password_Next).click().perform()
            time.sleep(100)
            try:
                WebDriverWait(driver, 5).until(EC.presence_of_element_located((By.XPATH, "//div[@jsname='EBHGs']")))
                confirm_recovery_email = driver.find_element(by=By.XPATH, value="//div[@jsname='EBHGs']")
                confirm_recovery_email.click()
                time.sleep(2)
                try:
                    WebDriverWait(driver, 5).until(EC.presence_of_element_located((By.ID, "knowledge-preregistered-email-response")))
                    input_recovery_email = driver.find_element(by=By.ID, value="knowledge-preregistered-email-response")
                    input_recovery_email.send_keys(recovery_email)
                    input_recovery_email.send_keys(Keys.ENTER)
                    time.sleep(2)
                    try:
                        WebDriverWait(driver, 5).until(EC.presence_of_element_located((By.TAG_NAME, "button")))
                        not_now_button = driver.find_element(by=By.TAG_NAME, value="button")
                        not_now_button.click()
                        time.sleep(2)
                    except:
                        pass
                except:
                    pass
            except:
                print("x")
                try:
                    WebDriverWait(driver, 5).until(EC.presence_of_element_located((By.XPATH, "//a[@jsname='hSRGPd']")))
                    print("1")
                    continue_button = driver.find_element(by=By.XPATH, value="//a[@jsname='hSRGPd']")
                    continue_button.click()
                    print("u")
                    try:
                        WebDriverWait(driver, 5).until(EC.presence_of_element_located((By.XPATH, "//button[@jsname='LgbsSe']")))
                        print("11")
                        weiter_button = driver.find_element(by=By.XPATH, value="//button[@jsname='LgbsSe']")
                        weiter_button.click()
                        print("uu")
                    except:
                        print("yy")
                        pass
                except:
                    time.sleep(2000)
                    print("y")
                    pass
                pass
        except:
            try:
                WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, "//img[@jsname='O9Milc']")))
                captcha_field = driver.find_element(by=By.XPATH, value="//img[@jsname='O9Milc']")
                print("111")
                time.sleep(1)
                captcha_image_url = driver.find_element(by=By.XPATH, value="//img[@jsname='O9Milc']").get_attribute('src')
                print("222")
                time.sleep(1)
                response = requests.get(captcha_image_url)
                print(response)
                print("333")
                time.sleep(1)
                with open('captcha.png', 'wb') as f:
                    f.write(response.content)
                img = open("captcha.png", "rb")
                print("444")
                captcha_api_key = "16c263a1dbaac62f2f926bd44994efa5"
                captcha_image = response.content
                captcha_image_base64 = base64.b64encode(captcha_image).decode("utf-8")
                # print(captcha_image_base64)
                print("555")
                captcha_api_url = f"https://2captcha.com/in.php?key={captcha_api_key}&method=base64&json=1"
                print("666")
                time.sleep(1)
                response = requests.post(url=captcha_api_url, data={"body":captcha_image_base64})
                print("777")
                time.sleep(5)
                print(response.json())
                captcha_id = response.json()["request"]
                print("888")
                print(captcha_id)
                captcha_result_url = f"https://2captcha.com/res.php?key={captcha_api_key}&action=get&id={captcha_id}"
                time.sleep(1)
                print("999")
                response = requests.get(captcha_result_url)
                time.sleep(5)
                print(response.content)
                time.sleep(1000)
                # try:
                #     captcha_response = requests.post('https://2captcha.com/in.php', files={'file': open('captcha.png', 'rb')}, data={'key': captcha_api_key}).json()
                #     print(captcha_response)
                #     print("555")
                #     captcha_id = captcha_response['captcha']
                #     print("666")
                #     time.sleep(10)

                #     captcha_result = request
                # s.get(f'http://2captcha.com/res.php?key={captcha_api_key}&action=get&id={captcha_id}').text
                #     print("777")
                #     captcha_response = captcha_result.split('|')[1]
                #     print("888")
                #     captcha_field.send_keys(captcha_response)
                #     time.sleep(10)
                # except ValueError:
                #     print(ValueError)
                #     pass
            except:
                print("000")
                pass
    except:
        pass
    pickle.dump(driver.get_cookies(), open('cookies.txt', 'wb'))
    return driver



def main():
    driver = driver_chrome_incognito()
    login_to_gmail(driver=driver, email="pathraporn112233@gmail.com", password="hgukZvkaMjbn", recovery_email="crosschase393202@hotmail.com")

if __name__ == '__main__':
    main()

#name = "Passwd"
#name = "ConfirmPasswd"